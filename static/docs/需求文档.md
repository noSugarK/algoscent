# 物资采购与价格管理系统 - 开发需求文档（修订修订版）

## 一、项目概述

### （一）项目背景
为实现物资采购流程的数字化管理，提升采购数据的透明度与分析能力，特开发本物资采购与价格管理系统。系统将整合地区、物资、采购订单、价格等核心数据，通过专业化的管理功能与可视化分析，为企业采购决策提供数据支持。

### （二）技术栈说明
- **后端框架**：Django 4.x（Python）
- **前端框架**：Vue 3（搭配Pinia状态管理和Vue Router）
- **UI组件库**：Element Plus
- **数据库**：MySQL 8.0
- **部署方式**：Docker容器化部署
- **API交互**：RESTful API + JWT认证
- **可视化库**：ECharts
- **开发模式**：前后端分离

### （三）项目目标
1. 实现13张核心数据表的全生命周期管理（CRUD操作）
2. 建立基于用户角色和数据权限的双层权限管理体系
3. 提供多维度的数据可视化分析功能
4. 确保系统稳定、安全、易用，支持容器化快速部署

## 二、功能需求

### （一）系统基础功能

#### 1. 用户认证与管理
- **登录功能**
  - 支持用户名/密码登录
  - 实现JWT令牌认证机制
  - 登录失败处理（5次失败后锁定30分钟）
  - 支持"记住我"功能（可配置有效期）
  - 记录最后登录时间（last_login字段）
  
- **用户管理**
  - **用户创建权限控制**：
    - 超级管理员：可创建所有类型用户（包括管理员和普通用户）
    - 管理员：只能创建普通用户
    - 普通用户：无创建用户权限
  - 管理员可编辑、禁用用户账号（超级管理员可管理所有用户，管理员只能管理普通用户）
  - 支持用户信息维护（姓名、联系方式等）
  - 密码重置功能（需管理员权限或邮箱验证）
  - 用户列表支持分页、搜索和筛选
  - 记录用户创建者（通过created_by字段）

- **权限管理**
  - 基于用户角色的权限控制：
    - 超级管理员（is_superuser=true）：拥有系统所有权限
    - 管理员（is_staff=true且is_superuser=false）：拥有系统管理权限，可管理普通用户
    - 普通用户（is_superuser=false且is_staff=false）：仅拥有被分配的权限
  - 基于数据范围的权限控制：
    - 通过项目权限表控制用户对特定项目的访问权限
    - 通过地区权限表控制用户对特定地区的访问权限
  - 权限粒度：功能权限（增删改查）和数据权限（项目/地区维度）

#### 2. 数据字典管理
- 物资类别（MATERIAL_CATEGORY）管理
- 规格（SPECIFICATION）管理
- 品牌（BRAND）管理
- 供应商（SUPPLIER）管理
- 所有字典支持树形结构展示（如适用）和批量导入导出

### （二）核心业务功能

#### 1. 地区管理（REGION）
- 支持地区层级展示（树形结构）
- 实现市级与区县级地区的关联管理
- 支持地区信息的增删改查
- 地区数据导入导出功能

#### 2. 项目管理（PROJECT）
- 项目基本信息管理（名称、所属地区等）
- 项目与地区的关联维护
- 支持按地区筛选查看项目
- 项目数据统计与关联订单查看
- **项目权限分配**：为普通用户分配特定项目的查看/编辑/管理权限

#### 3. 采购订单管理（PURCHASE_ORDER）
- 订单录入功能，包含完整的订单信息字段
- 自动计算功能：总金额=数量×采购价×(1-折扣率)
- 订单筛选功能（按项目、时间、供应商、物资类别等）
- 订单状态管理（待审核、已审核、已发货、已到货、已取消）
- 订单审批流程：支持指定审批人（approved_by）和审批时间（approved_at）
- 订单详情查看与历史记录追踪
- 支持订单导出为Excel格式
- **权限控制**：用户只能查看/编辑自己有权限的项目或地区的订单

#### 4. 指导价格管理（GUIDE_PRICE）
- 价格信息录入与维护
- 按地区、类别、规格、时间多维度筛选
- 价格数据批量导入（支持Excel）
- 导入记录自动关联到DATA_SUBMISSION表
- 价格数据导出功能
- **权限控制**：用户只能查看/编辑自己有权限的地区的价格数据

#### 5. 数据提交管理（DATA_SUBMISSION）
- 展示所有数据提交记录（手动录入、文件导入、API提交）
- 支持查看导入失败的错误日志
- 处理状态管理（待处理、成功、失败、已审核）
- 提交记录筛选与查询功能

#### 6. 权限分配管理
- **项目权限管理**：
  - 为普通用户分配特定项目的权限（view/edit/manage）
  - 查看用户已分配的项目权限列表
  - 编辑和撤销项目权限
- **地区权限管理**：
  - 为普通用户分配特定地区的权限（view/edit/manage）
  - 查看用户已分配的地区权限列表
  - 编辑和撤销地区权限

### （三）可视化分析功能

#### 1. 价格趋势分析
- 地区各物资信息价走势图（折线图）
- 支持多地区、多规格价格对比
- 价格波动预警功能（偏离平均值一定比例）
- 可按时间粒度（月/季/年）查看趋势
- **权限控制**：仅展示用户有权限查看的地区数据

#### 2. 项目采购分析
- 项目采购成本对比图（柱状图）
- 项目物资采购占比分析（饼图）
- 项目采购价格与信息价对比分析
- 支持按时间范围筛选数据
- **权限控制**：仅展示用户有权限查看的项目数据

#### 3. 采购订单分析
- 订单数量与金额趋势图（组合图）
- 供应商采购占比分析（环形图）
- 物资类别采购分布（热力图）
- 订单状态分布统计（饼图）
- **权限控制**：仅展示用户有权限查看的数据

#### 4. 自定义报表
- 支持用户自定义分析维度
- 报表保存与分享功能
- 报表数据导出功能

### （四）系统管理功能

#### 1. 系统配置
- 基础参数设置（如会话超时时间）
- 数据备份策略配置
- 日志级别设置

#### 2. 操作日志
- 记录关键操作（登录、权限变更、数据删除等）
- 日志查询与导出功能
- 异常操作告警

#### 3. 数据维护
- 数据库备份与恢复功能
- 数据清理工具（如过期日志删除）

## 三、技术需求

### （一）后端技术实现

1. **Django架构**
   - 采用Django REST framework构建API
   - 使用Django ORM实现数据库交互
   - 实现基于JWT的身份认证
   - 自定义权限类实现基于角色和数据范围的权限控制

2. **数据库设计**
   - 严格按照提供的ER图实现数据模型
   - 实现必要的索引优化查询性能
   - 设计合理的数据库迁移脚本
   - 实现用户-项目权限和用户-地区权限的关联查询

3. **API开发**
   - 所有接口遵循RESTful设计规范
   - 实现接口数据验证与错误处理
   - 支持数据分页、排序和筛选
   - API文档自动生成（使用drf-yasg）
   - 实现基于权限的API访问控制

4. **安全实现**
   - 密码加密存储（使用Django内置加密）
   - 实现API访问频率限制
   - 敏感数据传输加密
   - SQL注入防护

### （二）前端技术实现

1. **Vue 3实现**
   - 采用Vue 3 Composition API组织代码
   - 使用Pinia管理全局状态
   - Vue Router实现路由管理与权限控制
   - 组件化开发，提高代码复用率

2. **UI与交互**
   - 基于Element Plus构建界面
   - 实现响应式布局，适配不同设备
   - 统一的表单验证与错误提示
   - 加载状态与操作反馈设计
   - 基于用户权限动态渲染菜单和操作按钮

3. **数据可视化**
   - 基于ECharts实现各类图表
   - 图表交互功能（筛选、钻取、详情查看）
   - 图表数据缓存与刷新机制
   - 基于用户权限过滤图表数据

4. **前端安全**
   - XSS攻击防护
   - 路由权限控制
   - 本地存储数据加密

### （三）部署与运维

1. **Docker部署**
   - 编写Dockerfile构建前后端镜像
   - 使用docker-compose管理多容器应用
   - 实现开发、测试、生产环境隔离

2. **CI/CD流程**
   - 支持自动化测试与构建
   - 实现版本控制与发布管理
   - 提供部署文档与脚本

3. **监控与日志**
   - 系统运行状态监控
   - 错误日志收集与分析
   - 性能指标监控

## 四、数据模型说明

### 数据表结构

![数据表结构](/static/images/数据库设计.png)

### 权限控制逻辑

1. **角色权限逻辑**：
   - 超级管理员（is_superuser=true）：拥有所有功能权限和数据访问权限
   - 管理员（is_staff=true且is_superuser=false）：拥有系统管理权限，可管理普通用户，拥有所有数据访问权限
   - 普通用户：仅拥有被分配的项目/地区权限

2. **数据权限逻辑**：
   - 项目权限：控制用户对特定项目的访问权限（view/edit/manage）
   - 地区权限：控制用户对特定地区的访问权限（view/edit/manage）
   - 权限继承：拥有地区权限的用户自动拥有该地区下所有项目的相应权限

## 五、非功能需求

### （一）性能需求
- 页面加载时间：首次加载<3秒，二次加载<1秒
- 数据查询响应：简单查询<500ms，复杂查询<2秒
- 并发支持：同时在线用户≥100人
- 数据导入：单次导入1000条记录<10秒

### （二）安全需求
- 符合国家数据安全相关法规
- 实现完整的用户认证与授权机制
- 敏感数据加密存储
- 定期数据备份（每日自动备份）
- 操作日志留存至少1年
- 严格的权限校验，防止越权访问

### （三）易用性需求
- 界面风格统一，操作逻辑一致
- 提供清晰的操作指引与帮助信息
- 关键操作提供确认机制，防止误操作
- 支持键盘快捷操作
- 基于用户权限自动适配可操作功能

### （四）可扩展性需求
- 模块化设计，支持功能扩展
- API版本控制，确保兼容升级
- 支持数据接口与第三方系统集成
- 可配置的业务规则与流程

## 六、交付物清单

1. **源代码**
   - 后端Django项目源代码
   - 前端Vue 3项目源代码
   - 数据库脚本与迁移文件

2. **部署文档**
   - 环境搭建说明
   - Docker部署指南
   - 系统配置说明

3. **用户文档**
   - 管理员操作手册
   - 普通用户使用指南
   - 功能模块说明文档

4. **API文档**
   - 接口说明文档
   - 接口调用示例

5. **测试报告**
   - 功能测试报告
   - 性能测试报告
   - 安全测试报告

## 七、项目实施计划

1. **需求分析与设计阶段**（2周）
   - 详细需求确认
   - 数据库设计
   - 接口设计
   - UI原型设计

2. **开发阶段**（8周）
   - 后端API开发（4周）
   - 前端页面开发（4周）
   - 前后端联调（并行）

3. **测试阶段**（2周）
   - 功能测试
   - 性能测试
   - 安全测试
   - 用户验收测试

4. **部署与培训阶段**（2周）
   - 系统部署
   - 数据迁移
   - 用户培训

总周期：约14周
